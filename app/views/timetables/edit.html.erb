<script type="text/javascript" charset="utf-8">
  // Loop over the table cells and collect the ones that are checked
  // 61 td cells per column
  // free_times[0] == Sunday
  // free_times[0][0][0] = First Start Time on Sunday
  // free_times[0][0][1] = First End Time on Sunday
  function set_times_field() {
    var current_class = '';
    var blocks = 0;
    var been_free = false;
    var current_day;
    free_times = [[new Array], [new Array], [new Array], [new Array], [new Array], [new Array], [new Array]];
    for(i = 0; i < 7; i++) {
        // Go down each column
      for(c_index = 0; c_index < possible_classes.length; c_index++) {
        css_class = possible_classes[c_index];
        // if(css_class == 'bad') {continue}
        $('table#schedule td.day_' + i).each(function(index) {
        // css = $(this).attr('class');
          if($(this).hasClass(css_class)) {
            if(current_class != css_class) {
              day = i;
              // alert(day);
              current_class = css_class;
              been_free = true;
              if(day != current_day) {
                current_day = day;
                blocks = 0;
              }
              // alert($(this).find('input').val())
              // free_times[day] = new Array;
              // alert(blocks);
              free_times[day][blocks] = new Array;
              free_times[day][blocks][0] = Number($(this).find('input').val());
              // alert(free_times[day][blocks][0]);
              // Set End Time *INTERVAL* mins later
              free_times[day][blocks][1] = Number($(this).find('input').val()) + (<%= Timetable::INTERVAL %>);
              
              free_times[day][blocks][2] = $('#' + css_class).val();
              free_times[day][blocks][3] = css_class;
            } else {
              // alert(css_class)
              // Set End Time *INTERVAL* mins later
              free_times[day][blocks][1] = Number($(this).find('input').val()) + (<%= Timetable::INTERVAL %>);
              // free_times[day][blocks][2] = $('#' + css_class).val();
              // alert(free_times[day][blocks][1]);
            }
          } else {
            if(been_free) {
               blocks++;
               been_free = false;
               // alert(blocks);
            }
            current_class = '';
          }
        });
      }
    }
    $('#times').val($.toJSON(free_times));
  }
  

</script>
<%- form_for [@person, @timetable], :html => {:onsubmit => "set_times_field()"} do |f| -%>
  <%= hidden_field_tag :times %>
  <%= f.submit 'Save Timetable' %>
<%- end -%><br/>
<%= radio_button_tag 'paint', Timetable::BAD_WEIGHT, true, :id => Timetable::BAD_CLASS %> Bad 
<%= radio_button_tag 'paint', Timetable::POOR_WEIGHT, false, :id => Timetable::POOR_CLASS %> Poor 
<%= radio_button_tag 'paint', Timetable::OK_WEIGHT, false, :id => Timetable::OK_CLASS %> OK 
<%= radio_button_tag 'paint', Timetable::GOOD_WEIGHT, false, :id => Timetable::GOOD_CLASS %> Good
<%= render :partial => 'timetable' %>
<script>
  var down = false;
  var css = '<%= Timetable::BAD_CLASS %>';
  var possible_classes = ['<%= Timetable::BAD_CLASS %>', '<%= Timetable::POOR_CLASS %>', '<%= Timetable::OK_CLASS %>', '<%= Timetable::GOOD_CLASS %>']
  var direction = 'on';
  
  $("input[name='paint']").click(function() {
    css = this.id;
  });
  
  $('table#schedule td:not(.time)').mousedown(function() {
    down = true;
    for(i=0; i < possible_classes.length; i++) {
      $(this).removeClass(possible_classes[i]);
    }
    $(this).addClass(css)
  });
  $('table#schedule td:not(.time)').mouseover(function() {
    if(down) {
      for(i=0; i < possible_classes.length; i++) {
        $(this).removeClass(possible_classes[i]);
      }
      $(this).addClass(css)
    }
  });
  $('body').mouseup(function() {
    down = false;
  });
   $('table#schedule td').disableTextSelect();
</script>