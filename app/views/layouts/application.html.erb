<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
       "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="content-type" content="text/html;charset=UTF-8" />
    <link rel="shortcut icon" href="/favicon.ico" />
    <%# Check if the web_title config option is set, and if so, use it %>
    <title>
      <% if Cmt::CONFIG[:web_title] %>
        <%= Cmt::CONFIG[:web_title] %>
      <% else %>
        Campus Movement Tracker
      <% end %>
      <%= ': ' + @site_title if @site_title -%>
    </title>
    <%= stylesheet_link_tag "ext/ext-all", "style", "thickbox", "ext/xtheme-gray", :media => "screen", :cache => false %>
    <%= javascript_include_tag :defaults, 'person', 'thickbox-compressed', 'alternate', 'ext-jquery-adapter', 'ext-all', 'json',
                                'jquery.disable.text.select.pack', 'jquery.scrollTo-min', :cache => true %>
    <%= yield :javascripts %>

    <%= stylesheet_link_tag "/javascripts/jscalendar-1.0/skins/aqua/theme.css" %>
    <%- if logged_in? -%>
      <%= stylesheet_link_tag "connexion_default.css" %>
    <%- end -%>
    <%= javascript_include_tag "jscalendar-1.0/calendar.js", "jscalendar-1.0/lang/calendar-en.js", "jscalendar-1.0/calendar-setup.js", :cache => 'calendar' %>

    <%= fb_connect_javascript_tag if Cmt::CONFIG[:facebook_connectivity_enabled] %>
  </head>

	<body>
    <%= render :partial => "/link_bar/link_bar" if logged_in? && @me %>
      
    <%= init_fb_connect('XFBML', :js => :jquery) if Cmt::CONFIG[:facebook_connectivity_enabled]%>
		<div id="outer">
    <%= connexion_bar if Cmt::CONFIG[:gcx_connexion_bar] %>


		<div id="wrapper">
		  <div id="userbar">
        <div id="logos">
          <%= image_tag "c4clogo.png" %>
          <%= image_tag "pulselogo.png" %>
        </div>


        <% if logged_in? && @me && !@custom_userbar_title %>


        <%= render :partial => "/search/search_box", :locals => { :q => @q } %>
        

        <% if Cmt::CONFIG[:facebook_connectivity_enabled] && facebook_session %>
          <a href="#" class="logoutbutton" onclick="try {
            FB.Connect.logoutAndRedirect('<%= logout_url %>');
            } catch (e) { alert('RJS error:\n\n' + e.toString()); alert('FB.Connect.logoutAndRedirect(\'<%= logout_url %>\');'); throw e }; return false;">logout</a>
        <% end %>

        <div id="userblock" class="link_bar">
          Hi&nbsp;
          <div id="username"><%= link_to @my.full_name, person_path(@me), :title => "Goto your profile" %></div>
          
          <%- if authorized?(:switch_list, :ministries) && authorized?(:switch_apply, :ministries) %>
            <div id="switch_ministries"><%- if @ministry -%>&nbsp;&nbsp;<%= link_to_remote @ministry.name, :url => switch_list_ministries_url %><%- end -%></div>
            <div id="switch_ministries_list" style="display:none">
              &nbsp;
            </div>
          <%- end -%>
        </div>
        
        <div class="clear"></div>

      </div>

      <div id="greenbar">
        <%= tabnav :main %>
      </div>


      <%- else -%>

        <div id="userblock">
        </div>
        <div class="clear"></div>
      </div>

      <div id="greenbar">
        <div id="signin"><%= @custom_userbar_title || link_to(I18n.t(:please_login, :default => 'Please Login'), CASClient::Frameworks::Rails::Filter.login_url(controller)) %></div>
      </div>

      <%- end -%>


      <div class="clear">&nbsp;</div>

      <noscript>
        <div class="flash_notice warning">
        For full functionality of this site it is necessary to enable JavaScript.
        Here are the <a href="http://www.enable-javascript.com/" target="_blank">
        instructions how to enable JavaScript in your web browser</a>.</div>
      </noscript>

      <div class="flash notice" id="flash_notice" <%= "style=\"display:none;\"" unless flash[:notice] %>><%= flash[:notice] %></div>
                        <%- if @notices -%>
                          <%- for notice in @notices -%>
                            <div class="flash_notice" id="notice_<%= notice.id %>"><%= notice.message %> <%= link_to_remote "Hide", :url => dismiss_notice_url(notice.id), :method => :post %></div>
                          <%- end %>
                        <%- end %>
      <div class="flash warning" id="flash_warning" <%= "style=\"display:none;\"" unless flash[:notice] %>><%= flash[:warning] %></div>
      <div id="instructions" class="flash_notice notice" style="display:none;"></div>

      <div id="content">
        <%= yield %>
        <div class="clear">&nbsp;</div>
        <br />
      </div>
    </div> <!-- Wrapper -->

    <div id="dialog" style="display:none"></div>
    </div> <!-- Center -->
    <div id="footer">
    </div>
    <%= I18n.t :analytics, :default => "" %>

    <% user_agent = request.env['HTTP_USER_AGENT'].downcase %>
    <% unless user_agent =~ /msie/i %>
      <!-- BEGIN: SeeVolution --><img width=0 height=0 src="https://c.svlu.net/pixel.aspx"/><script type="text/javascript" src="https://c.svlu.net/JInitScript.js"></script><!-- END: SeeVolution  -->
    <% end %>
  </body>
</html>
